---
title: "Slupsk dashboard"
output: 
  flexdashboard::flex_dashboard:
    theme: bootstrap
    logo: "img/logo_creating-interfaces_100x48.png"
    # favicon: favicon.png
    orientation: rows
---

```{r setup, include=FALSE}
library(flexdashboard)
library(plotly)
library(DT)
library(formattable)
library(lubridate)
library(tidyverse)
library(scales)
library(wfenexus)

# Load data
kindergarten_df <- read_csv("data-raw/kindergarten_kindergarten.csv")
ingredients_df <- read_csv("data-raw/ingredient_ingredient.csv")
dish_composition <- read_csv("data-raw/kindergartendish_composition.csv")
dishrating <- ci_dishratings_prep("data-raw/dishrating.csv")
dishes_df <- read_csv("data-raw/kindergartendish_kindergartendish.csv")


dishes_df <- ci_dishratings(dishes_df, dishrating)


# Colours
color_food <- "#95C448"
color_water <- "#00A9AE"
color_energy <- "#EBC11F"

color_background <- "#34767A"

color_wfp_blue <- "#65C6F0"
color_wfp_green <- "#A2D729"
color_wfp_grey <- "#8f8f98"


```

<!-- Inputs {.sidebar} -->
<!-- ------------------------------------- -->

<!-- This is not working. That would require configuring a shiny server. -->

<!-- ```{r} -->
<!-- # shiny inputs defined here -->
<!-- ``` -->



Overview
=====================================

Valueboxes
---------------------------------------

### kindergartens {.value-box .no-mobile}

```{r}

valueBox(value = format(nrow(kindergarten_df), big.mark = "."), 
         caption = "Kindergartens involved in the project.", 
         icon = "fas fa-school")
```

### dishes {.value-box .no-mobile}

```{r}

valueBox(value = nrow(ingredients_df), 
         caption = "Number of dishes.", 
         icon = "fas fa-utensils")
```

### ingredients {.value-box .no-mobile}

```{r}

valueBox(value = nrow(dishes_df), 
         caption = "Number of ingredients.", 
         icon = "fas fa-lemon")
```

Notes
--------

* What are the consequences of our choices?
* Which small changes can we make in our food to make them more sustainable?



Notes
--------

![](https://www.r-graph-gallery.com/143-spider-chart-with-saveral-individuals_files/figure-html/thecode2-1.png)

Links: https://www.datanovia.com/en/blog/beautiful-radar-chart-in-r-using-fmsb-and-ggplot-packages/

Notes
--------

The possible radar's axis could be:

* Health (Food)
* Rating parents (Food)
* Rating children (Food)
* Water Footprint
* Energy Footprint
* calories? (Energy?)


Food
===================================== 


Meals {.tabset}
-----------------------------------------------------------------------

### Ingredients 

Some information about ingredients here:

* Ingredients table with the following info:
  * Name
  * Kcals -> Not available
  * Water footprint -> we'd need to calculate that by ourselves



### Meals

Possible ideas:

* Top meals by parents/children
* Most difference of rating between parents and children

### Meals' summary table

```{r}

# Load dataset.

dishes_df %>% 
  select(kindergarten_id, type, name, health, waste, allergens, calories, 
         rating_children, rating_parents) %>% 
  arrange(kindergarten_id, type) %>% 
  datatable()


```

### Producers 

Map + figures stating the amount of savings that we could get if all ingredients were produced from them.
We'd need to know what they produce.

Column 
-----------------------------------------------------------------------

### Chart B

```{r}
library(formattable)

dishes_df %>% 
  select(kindergarten_id, type, name, waste, allergens, calories, 
         rating_children, rating_parents) %>% 
  arrange(kindergarten_id, type) %>% 
  formattable()


```

### Chart C

```{r}

```


Water
===================================== 

```{r}
wfp_combined <- read.csv(file = "data/wfp_combined.csv") %>% 
  select(-id, -name, -name_wf, -description) %>% 
  mutate(green_variation = (-world_green + country_green)/world_green,
         blue_variation = (-world_blue + country_blue)/world_blue,
         grey_variation = (-world_grey + country_grey)/world_grey,
         total_variation = (-world_total + country_total)/world_total) %>%
  # mutate(across(ends_with("_variation"), scales::percent)) %>%
  mutate(across(is.numeric, round, 2)) %>%
  relocate(green_variation, .after = country_green) %>%
  relocate(blue_variation, .after = country_blue) %>%
  relocate(grey_variation, .after = country_grey) %>%
  relocate(total_variation, .after = country_total) %>%
  arrange(desc(world_total)) %>% 
  relocate(type, .before = "name_en")

stats_wfp <- wfp_combined %>% 
  group_by(type) %>% 
  summarise(mean = mean(world_total), total = sum(world_total),
            mean_local = mean(country_total, na.rm=T), total_local = sum(country_total))

avg_wfp_animals <- round(stats_wfp$mean[1], 2)
avg_wfp_crops <- round(stats_wfp$mean[2], 2)

avg_wfp_animals_local <- round(stats_wfp$mean_local[1], 2)
avg_wfp_crops_local <- round(stats_wfp$mean_local[2], 2)
  
```

Valueboxes
---------------------------------------

### wfp_animals {.value-box .no-mobile}

```{r}

valueBox(value = paste0(format(avg_wfp_animals, big.mark = ","), " m3/Ton"), 
         caption = "is the average water footprint of the ingredients from animal origin", 
         icon = "fas fa-paw")
```

### wfp_crops {.value-box .no-mobile}

```{r}

valueBox(value = paste0(format(avg_wfp_crops, big.mark = ","), " m3/Ton"), 
         caption = "is the average water footprint per crops worldwide", 
         icon = "fas fa-leaf")
```

### wfp_animals_local {.value-box .no-mobile}

```{r}

valueBox(value = paste0(format(avg_wfp_animals_local, big.mark = ","), " m3/Ton"), 
         caption = "is the average water footprint if animals were grazed localy", 
         icon = "fas fa-paw")
```

### wfp_crops_local {.value-box .no-mobile}

```{r}

valueBox(value = paste0(format(avg_wfp_crops_local, big.mark = ","), " m3/Ton"), 
         caption = "is the average water footprint if using local crops only (if possible). this represents XX less", 
         icon = "fas fa-leaf")
```

Water {.tabset}
-----------------------------------------------------------------------

### Ingredients 

```{r}


formattable(
  wfp_combined,  
  list(
    world_green = color_tile("transparent", color_wfp_green),
    world_blue = color_tile("transparent", color_wfp_blue),
    world_grey = color_tile("transparent", color_wfp_grey),
    world_total = color_tile("transparent", color_water),
    country_green = color_tile("transparent", color_wfp_green),
    country_blue = color_tile("transparent", color_wfp_blue),
    country_grey = color_tile("transparent", color_wfp_grey),
    country_total = color_tile("transparent", color_water),
    green_variation =  formatter("span", 
      style = ~ style(color = ifelse(green_variation < 0, "green", "red"))),
    blue_variation =  formatter("span", 
      style = ~ style(color = ifelse(blue_variation < 0, "green", "red"))),
    grey_variation =  formatter("span", 
      style = ~ style(color = ifelse(grey_variation < 0, "green", "red"))),
    total_variation =  formatter("span", 
      style = ~ style(color = ifelse(total_variation < 0, "green", "red")))
  )
) %>%
  as.datatable(escape = FALSE,
               class= "hover",
               # options = list(scrollX = TRUE),
               rownames = FALSE,
               extensions = 'Scroller', options = list(
                 deferRender = TRUE,
                 scrollY = 200,
                 scroller = TRUE)
  )
  
```

### Ingredients 2

```{r}
wfp_combined %>% 
  select(-green_variation, -blue_variation, -grey_variation) %>% 
  formattable(list(
    world_green = color_tile("transparent", color_wfp_green),
    world_blue = color_tile("transparent", color_wfp_blue),
    world_grey = color_tile("transparent", color_wfp_grey),
    world_total = color_tile("transparent", color_water),
    country_green = color_tile("transparent", color_wfp_green),
    country_blue = color_tile("transparent", color_wfp_blue),
    country_grey = color_tile("transparent", color_wfp_grey),
    country_total = color_tile("transparent", color_water),
    green_variation =  formatter("span", 
      style = ~ style(color = ifelse(green_variation < 0, "green", "red"))),
    blue_variation =  formatter("span", 
      style = ~ style(color = ifelse(blue_variation < 0, "green", "red"))),
    grey_variation =  formatter("span", 
      style = ~ style(color = ifelse(grey_variation < 0, "green", "red"))),
    total_variation =  formatter("span", 
      style = ~ style(color = ifelse(total_variation < 0, "green", "red")))
  )
) %>%
  as.datatable(escape = FALSE,
               class= "hover",
               # options = list(scrollX = TRUE),
               rownames = FALSE,
               extensions = 'Scroller', options = list(
                 deferRender = TRUE,
                 scrollY = 200,
                 scroller = TRUE)
  )
  
```

### Ingredients 3

Try this other library: https://glin.github.io/reactable/articles/examples.html#footers-1

Heatmaps could be implemented this way: https://glin.github.io/reactable/articles/conditional-styling.html and this: https://glin.github.io/reactable/articles/cookbook/cookbook.html

Also try with custom filters: https://glin.github.io/reactable/articles/examples.html#cross-widget-interactions-1

Links:

* https://clarewest.github.io/blog/post/making-tables-shiny/

### Meals 

-------
### Things to consider

* Water footprint units are m3/Tonne
* Water footprint figures were obtained from https://waterfootprint.org/
* Not all the ingredients used in Slupsk's kindergartens were listed in Hoepstra's work.
* Fishes' water footprint is NULL (check that. At least, they do not appear in Hoepstra's work)
* Not all crops can't be cultivated in Poland



Energy
===================================== 

We do not have any data regarding energy.


About
===================================== 

#### About this dashboard


An open source prototype for a visual interface to support research and Nexus engagements, designed collaborativelly as part of [Creating interfaces](https://creatinginterfaces.eifer.kit.edu/)' WP4, developed by the [Institute for Global Sustainable Development](https://warwick.ac.uk/fac/arts/schoolforcross-facultystudies/igsd) at the [University of Warwick](https://warwick.ac.uk/).

![](img/IGSD_logo.jpg)


* Source Code: https://github.com/IGSD-UoW/wfenexus
* Licence: [GPL](https://github.com/IGSD-UoW/wfenexus/blob/main/LICENSE)
